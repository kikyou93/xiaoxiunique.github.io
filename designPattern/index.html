<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>我的学习测试</title>
    <meta name="description" content="我的学习测试">
    
    
    <link rel="preload" href="/assets/css/0.styles.c63ac9d8.css" as="style"><link rel="preload" href="/assets/js/app.3a816497.js" as="script"><link rel="preload" href="/assets/js/2.48b11553.js" as="script"><link rel="preload" href="/assets/js/38.825f4500.js" as="script"><link rel="prefetch" href="/assets/js/10.b89577a1.js"><link rel="prefetch" href="/assets/js/11.783604b9.js"><link rel="prefetch" href="/assets/js/12.54ed55d4.js"><link rel="prefetch" href="/assets/js/13.241ed680.js"><link rel="prefetch" href="/assets/js/14.f79ab3ad.js"><link rel="prefetch" href="/assets/js/15.f2bb3ba6.js"><link rel="prefetch" href="/assets/js/16.5eed36d4.js"><link rel="prefetch" href="/assets/js/17.c73921a4.js"><link rel="prefetch" href="/assets/js/18.e58de6a2.js"><link rel="prefetch" href="/assets/js/19.b2a8a042.js"><link rel="prefetch" href="/assets/js/20.df605c45.js"><link rel="prefetch" href="/assets/js/21.a514942d.js"><link rel="prefetch" href="/assets/js/22.f088b8f1.js"><link rel="prefetch" href="/assets/js/23.d5f8d985.js"><link rel="prefetch" href="/assets/js/24.5770e64c.js"><link rel="prefetch" href="/assets/js/25.a6e2a16c.js"><link rel="prefetch" href="/assets/js/26.83e58598.js"><link rel="prefetch" href="/assets/js/27.52735577.js"><link rel="prefetch" href="/assets/js/28.802eebb7.js"><link rel="prefetch" href="/assets/js/29.f161244d.js"><link rel="prefetch" href="/assets/js/3.350849cf.js"><link rel="prefetch" href="/assets/js/30.4fec3df3.js"><link rel="prefetch" href="/assets/js/31.23003ba3.js"><link rel="prefetch" href="/assets/js/32.c76f679c.js"><link rel="prefetch" href="/assets/js/33.c2c3871a.js"><link rel="prefetch" href="/assets/js/34.6bcc39bd.js"><link rel="prefetch" href="/assets/js/35.32abfdb0.js"><link rel="prefetch" href="/assets/js/36.1698b505.js"><link rel="prefetch" href="/assets/js/37.e5e9fc9f.js"><link rel="prefetch" href="/assets/js/39.00c1ac9d.js"><link rel="prefetch" href="/assets/js/4.b24dd4b9.js"><link rel="prefetch" href="/assets/js/40.3c8b3033.js"><link rel="prefetch" href="/assets/js/41.b66b4916.js"><link rel="prefetch" href="/assets/js/42.ad86d694.js"><link rel="prefetch" href="/assets/js/43.24ce6c85.js"><link rel="prefetch" href="/assets/js/44.eb05e054.js"><link rel="prefetch" href="/assets/js/45.a72bebcd.js"><link rel="prefetch" href="/assets/js/46.3559d3cc.js"><link rel="prefetch" href="/assets/js/47.e687d515.js"><link rel="prefetch" href="/assets/js/48.aa53e59e.js"><link rel="prefetch" href="/assets/js/49.243bb74d.js"><link rel="prefetch" href="/assets/js/5.445ea915.js"><link rel="prefetch" href="/assets/js/50.9d5b09c5.js"><link rel="prefetch" href="/assets/js/51.7319419a.js"><link rel="prefetch" href="/assets/js/52.02760e8c.js"><link rel="prefetch" href="/assets/js/53.c9b9bc72.js"><link rel="prefetch" href="/assets/js/54.6d5b0457.js"><link rel="prefetch" href="/assets/js/55.e39db9c6.js"><link rel="prefetch" href="/assets/js/56.f9f2b949.js"><link rel="prefetch" href="/assets/js/57.bc68ff71.js"><link rel="prefetch" href="/assets/js/58.4d51b510.js"><link rel="prefetch" href="/assets/js/59.3660de3b.js"><link rel="prefetch" href="/assets/js/6.caf28be5.js"><link rel="prefetch" href="/assets/js/60.24b5d777.js"><link rel="prefetch" href="/assets/js/61.c4f36dd9.js"><link rel="prefetch" href="/assets/js/62.bb33da07.js"><link rel="prefetch" href="/assets/js/63.7baf0019.js"><link rel="prefetch" href="/assets/js/7.97cf4434.js"><link rel="prefetch" href="/assets/js/8.d16fdfd2.js"><link rel="prefetch" href="/assets/js/9.eec41da1.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c63ac9d8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">我的学习测试</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/idea/" class="nav-link">IDEA</a></div><div class="nav-item"><a href="/devops/" class="nav-link">DevOps</a></div><div class="nav-item"><a href="/web/" class="nav-link">Web</a></div><div class="nav-item"><a href="/designPattern/" class="nav-link router-link-exact-active router-link-active">设计模式</a></div><div class="nav-item"><a href="/blog/" class="nav-link">杂记</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/idea/" class="nav-link">IDEA</a></div><div class="nav-item"><a href="/devops/" class="nav-link">DevOps</a></div><div class="nav-item"><a href="/web/" class="nav-link">Web</a></div><div class="nav-item"><a href="/designPattern/" class="nav-link router-link-exact-active router-link-active">设计模式</a></div><div class="nav-item"><a href="/blog/" class="nav-link">杂记</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>设计模式</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/designPattern/" class="active sidebar-link">设计原则</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/designPattern/单例模式.html" class="sidebar-link">单例模式</a></li><li><a href="/designPattern/工厂模式.html" class="sidebar-link">工厂模式</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p></p><div class="table-of-contents"><ul><li><a href="#设计原则指导思想">设计原则指导思想</a></li><li><a href="#srp-单一职责原则">SRP 单一职责原则</a></li><li><a href="#ocp-开放封闭原则">OCP 开放封闭原则</a></li><li><a href="#lsp-里式替换原则">LSP 里式替换原则</a></li><li><a href="#icp-接口隔离原则">ICP 接口隔离原则</a></li><li><a href="#dip-依赖倒置原则">DIP 依赖倒置原则</a></li><li><a href="#kiss-原则">Kiss 原则</a></li><li><a href="#yang">YANG</a></li><li><a href="#dry-原则">DRY 原则</a></li><li><a href="#lod-迪米特原则">LOD 迪米特原则</a></li></ul></div><p></p> <h3 id="设计原则指导思想"><a href="#设计原则指导思想" class="header-anchor">#</a> 设计原则指导思想</h3> <p>书写良好程序的总体思想都是为实现 <strong>高内聚低耦合</strong> 而服务的。</p> <p><strong>设计原则是指导思想</strong>，从思想上给我们指明程序设计的正确方向，是我们开发设计过程中应该尽力遵守的准则。</p> <p><strong>设计模式是实现手段</strong>，所以设计模式也需要遵守 <strong>设计原则</strong>，要达到的目标就是 <strong>高内聚低耦合</strong></p> <p>经典的设计原则包括 SOLID、KISS、YAGNI、DRY、LOD。</p> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>遵守设计原则是好，但是过犹不及，在实际项目中我们不要刻板遵守，需要根据实际情况灵活运用。</p></div> <h3 id="srp-单一职责原则"><a href="#srp-单一职责原则" class="header-anchor">#</a> SRP 单一职责原则</h3> <p>定义：一个类只负责完成一个职责或功能，不要设计<strong>大而全</strong>的类，要<strong>设计粒度小，功能单一</strong>的类。<strong>单一职责原则</strong>是为了实现代码高内聚、低耦合，提高代码的复用性、可读性、可维护性。</p> <p><strong>如何判断类的职责是否单一？</strong></p> <ul><li><p>类中的代码行数、函数或者属性过多。</p></li> <li><p>类依赖的其他类过多，或者依赖类的其他类过多。</p></li> <li><p>私有方法过多。</p></li> <li><p>比较难起一个合适的名字。</p></li> <li><p>类中大量的方法都是操作类中的某个属性。</p></li></ul> <p>评价一个类的职责是否足够单一，我们并没有一个非常明确的、可以量化的标准，可以说，这是件非常主观、仁者见仁智者见智的事情。实际上，在真正的软件开发中，我们也没必要过于未雨绸缪，过度设计。所以，<strong>我们可以先写一个粗粒度的类，满足业务需求。随着业务的发展，如果粗粒度的类越来越庞大，代码越来越多，这个时候，我们就可以将这个粗粒度的类，拆分成几个更细粒度的类。这就是所谓的持续重构</strong></p> <h3 id="ocp-开放封闭原则"><a href="#ocp-开放封闭原则" class="header-anchor">#</a> OCP 开放封闭原则</h3> <p>定义：软件实体（模块、类、方法）应该对 <strong>扩展开放，对修改关闭</strong>。</p> <p>这个描述比较简略，如果我们详细表述一下，那就是，添加一个新的功能应该是，在已有代码基础上扩展代码（新增模块、类、方法等），而非修改已有代码（修改模块、类、方法等）。</p> <p><strong>为了深入理解 OCP 原则，这里结合程序案列查看。</strong></p> <p>这是一段 API 接口监控告警的代码。其中，AlertRule 存储告警规则，可以自由设置。Notification 是告警通知类，支持邮件、短信、微信、手机等多种通知渠道。NotificationEmergencyLevel 表示通知的紧急程度，包括 SEVERE（严重）、URGENCY（紧急）、NORMAL（普通）、TRIVIAL（无关紧要），不同的紧急程度对应不同的发送渠道。</p> <div class="language-java extra-class"><pre class="language-java"><code>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Alert</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token class-name">AlertRule</span> rule<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">Notification</span> notification<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">Alert</span><span class="token punctuation">(</span><span class="token class-name">AlertRule</span> rule<span class="token punctuation">,</span> <span class="token class-name">Notification</span> notification<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>rule <span class="token operator">=</span> rule<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>notification <span class="token operator">=</span> notification<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token class-name">String</span> api<span class="token punctuation">,</span> <span class="token keyword">long</span> requestCount<span class="token punctuation">,</span> <span class="token keyword">long</span> errorCount<span class="token punctuation">,</span> <span class="token keyword">long</span> durationOfSeconds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> tps <span class="token operator">=</span> requestCount <span class="token operator">/</span> durationOfSeconds<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tps <span class="token operator">&gt;</span> rule<span class="token punctuation">.</span><span class="token function">getMatchedRule</span><span class="token punctuation">(</span>api<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxTps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      notification<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token class-name">NotificationEmergencyLevel</span><span class="token punctuation">.</span>URGENCY<span class="token punctuation">,</span> <span class="token string">&quot;...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>errorCount <span class="token operator">&gt;</span> rule<span class="token punctuation">.</span><span class="token function">getMatchedRule</span><span class="token punctuation">(</span>api<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxErrorCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      notification<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token class-name">NotificationEmergencyLevel</span><span class="token punctuation">.</span>SEVERE<span class="token punctuation">,</span> <span class="token string">&quot;...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面这段代码非常简单，业务逻辑主要集中在 check() 函数中。当接口的 TPS 超过某个预先设置的最大值时，以及当接口请求出错数大于某个最大允许值时，就会触发告警，通知接口的相关负责人或者团队。</p> <p>现在，如果我们需要添加一个功能，当每秒钟接口超时请求个数，超过某个预先设置的最大阈值时，我们也要触发告警发送通知。这个时候，我们该如何改动代码呢？主要的改动有两处：第一处是修改 check() 函数的入参，添加一个新的统计数据 timeoutCount，表示超时接口请求数；第二处是在 check() 函数中添加新的告警逻辑。具体的代码改动如下所示：</p> <div class="language-java extra-class"><pre class="language-java"><code>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Alert</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...省略AlertRule/Notification属性和构造函数...</span>
  
  <span class="token comment">// 改动一：添加参数timeoutCount</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token class-name">String</span> api<span class="token punctuation">,</span> <span class="token keyword">long</span> requestCount<span class="token punctuation">,</span> <span class="token keyword">long</span> errorCount<span class="token punctuation">,</span> <span class="token keyword">long</span> timeoutCount<span class="token punctuation">,</span> <span class="token keyword">long</span> durationOfSeconds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> tps <span class="token operator">=</span> requestCount <span class="token operator">/</span> durationOfSeconds<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tps <span class="token operator">&gt;</span> rule<span class="token punctuation">.</span><span class="token function">getMatchedRule</span><span class="token punctuation">(</span>api<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxTps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      notification<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token class-name">NotificationEmergencyLevel</span><span class="token punctuation">.</span>URGENCY<span class="token punctuation">,</span> <span class="token string">&quot;...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>errorCount <span class="token operator">&gt;</span> rule<span class="token punctuation">.</span><span class="token function">getMatchedRule</span><span class="token punctuation">(</span>api<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxErrorCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      notification<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token class-name">NotificationEmergencyLevel</span><span class="token punctuation">.</span>SEVERE<span class="token punctuation">,</span> <span class="token string">&quot;...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 改动二：添加接口超时处理逻辑</span>
    <span class="token keyword">long</span> timeoutTps <span class="token operator">=</span> timeoutCount <span class="token operator">/</span> durationOfSeconds<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeoutTps <span class="token operator">&gt;</span> rule<span class="token punctuation">.</span><span class="token function">getMatchedRule</span><span class="token punctuation">(</span>api<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxTimeoutTps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      notification<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token class-name">NotificationEmergencyLevel</span><span class="token punctuation">.</span>URGENCY<span class="token punctuation">,</span> <span class="token string">&quot;...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样的代码修改实际上存在挺多问题的。</p> <ul><li><p>我们对接口进行了修改，这就意味着调用这个接口的代码都要做相应的修改。</p></li> <li><p>修改了 check() 函数，相应的单元测试都需要修改。</p></li></ul> <p>上面的代码改动是基于“修改”的方式来实现新功能的。如果我们遵循开闭原则，也就是“对扩展开放、对修改关闭”。那如何通过“扩展”的方式，来实现同样的功能呢？</p> <p>我们先重构一下之前的 Alert 代码，让它的扩展性更好一些。重构的内容主要包含两部分：</p> <ul><li>第一部分是将 check() 函数的多个入参封装成 ApiStatInfo 类；</li> <li>第二部分是引入 handler 的概念，将 if 判断逻辑分散在各个 handler 中。</li></ul> <p>具体代码实现如下：</p> <div class="language-java extra-class"><pre class="language-java"><code>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Alert</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AlertHandler</span><span class="token punctuation">&gt;</span></span> alertHandlers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addAlertHandler</span><span class="token punctuation">(</span><span class="token class-name">AlertHandler</span> alertHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>alertHandlers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>alertHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token class-name">ApiStatInfo</span> apiStatInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AlertHandler</span> handler <span class="token operator">:</span> alertHandlers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      handler<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>apiStatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApiStatInfo</span> <span class="token punctuation">{</span><span class="token comment">//省略constructor/getter/setter方法</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> api<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">long</span> requestCount<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">long</span> errorCount<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">long</span> durationOfSeconds<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AlertHandler</span> <span class="token punctuation">{</span>
  <span class="token keyword">protected</span> <span class="token class-name">AlertRule</span> rule<span class="token punctuation">;</span>
  <span class="token keyword">protected</span> <span class="token class-name">Notification</span> notification<span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token class-name">AlertHandler</span><span class="token punctuation">(</span><span class="token class-name">AlertRule</span> rule<span class="token punctuation">,</span> <span class="token class-name">Notification</span> notification<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>rule <span class="token operator">=</span> rule<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>notification <span class="token operator">=</span> notification<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token class-name">ApiStatInfo</span> apiStatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TpsAlertHandler</span> <span class="token keyword">extends</span> <span class="token class-name">AlertHandler</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token class-name">TpsAlertHandler</span><span class="token punctuation">(</span><span class="token class-name">AlertRule</span> rule<span class="token punctuation">,</span> <span class="token class-name">Notification</span> notification<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> notification<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token class-name">ApiStatInfo</span> apiStatInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> tps <span class="token operator">=</span> apiStatInfo<span class="token punctuation">.</span><span class="token function">getRequestCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span> apiStatInfo<span class="token punctuation">.</span><span class="token function">getDurationOfSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tps <span class="token operator">&gt;</span> rule<span class="token punctuation">.</span><span class="token function">getMatchedRule</span><span class="token punctuation">(</span>apiStatInfo<span class="token punctuation">.</span><span class="token function">getApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxTps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      notification<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token class-name">NotificationEmergencyLevel</span><span class="token punctuation">.</span>URGENCY<span class="token punctuation">,</span> <span class="token string">&quot;...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ErrorAlertHandler</span> <span class="token keyword">extends</span> <span class="token class-name">AlertHandler</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token class-name">ErrorAlertHandler</span><span class="token punctuation">(</span><span class="token class-name">AlertRule</span> rule<span class="token punctuation">,</span> <span class="token class-name">Notification</span> notification<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> notification<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token class-name">ApiStatInfo</span> apiStatInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>apiStatInfo<span class="token punctuation">.</span><span class="token function">getErrorCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> rule<span class="token punctuation">.</span><span class="token function">getMatchedRule</span><span class="token punctuation">(</span>apiStatInfo<span class="token punctuation">.</span><span class="token function">getApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMaxErrorCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      notification<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token class-name">NotificationEmergencyLevel</span><span class="token punctuation">.</span>SEVERE<span class="token punctuation">,</span> <span class="token string">&quot;...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面的代码是对 Alert 的重构，我们再来看下，重构之后的 Alert 该如何使用呢？具体的使用代码我也写在这里了。</p> <p>其中，ApplicationContext 是一个单例类，负责 Alert 的创建、组装（alertRule 和 notification 的依赖注入）、初始化（添加 handlers）工作。</p> <div class="language-java extra-class"><pre class="language-java"><code>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationContext</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token class-name">AlertRule</span> alertRule<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">Notification</span> notification<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">Alert</span> alert<span class="token punctuation">;</span>
  
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initializeBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    alertRule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlertRule</span><span class="token punctuation">(</span><span class="token comment">/*.省略参数.*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//省略一些初始化代码</span>
    notification <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Notification</span><span class="token punctuation">(</span><span class="token comment">/*.省略参数.*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//省略一些初始化代码</span>
    alert <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Alert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    alert<span class="token punctuation">.</span><span class="token function">addAlertHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TpsAlertHandler</span><span class="token punctuation">(</span>alertRule<span class="token punctuation">,</span> notification<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    alert<span class="token punctuation">.</span><span class="token function">addAlertHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ErrorAlertHandler</span><span class="token punctuation">(</span>alertRule<span class="token punctuation">,</span> notification<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token class-name">Alert</span> <span class="token function">getAlert</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> alert<span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token comment">// 饿汉式单例</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ApplicationContext</span> instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">ApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    instance<span class="token punctuation">.</span><span class="token function">initializeBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ApplicationContext</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ApiStatInfo</span> apiStatInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApiStatInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...省略设置apiStatInfo数据值的代码</span>
    <span class="token class-name">ApplicationContext</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAlert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>apiStatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>现在，我们再来看下，基于重构之后的代码，如果再添加上面讲到的那个新功能，每秒钟接口超时请求个数超过某个最大阈值就告警，我们又该如何改动代码呢？主要的改动有下面四处。</p> <ul><li>第一处改动是：在 ApiStatInfo 类中添加新的属性 timeoutCount。</li> <li>第二处改动是：添加新的 TimeoutAlertHander 类。</li> <li>第三处改动是：在 ApplicationContext 类的 initializeBeans() 方法中，往 alert 对象中注册新的 timeoutAlertHandler。</li> <li>第四处改动是：在使用 Alert 类的时候，需要给 check() 函数的入参 apiStatInfo 对象设置 timeoutCount 的值。</li></ul> <p>改动后的代码：</p> <div class="language-java extra-class"><pre class="language-java"><code>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Alert</span> <span class="token punctuation">{</span> <span class="token comment">// 代码未改动... }</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApiStatInfo</span> <span class="token punctuation">{</span><span class="token comment">//省略constructor/getter/setter方法</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> api<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">long</span> requestCount<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">long</span> errorCount<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">long</span> durationOfSeconds<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">long</span> timeoutCount<span class="token punctuation">;</span> <span class="token comment">// 改动一：添加新字段</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AlertHandler</span> <span class="token punctuation">{</span> <span class="token comment">//代码未改动... }</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TpsAlertHandler</span> <span class="token keyword">extends</span> <span class="token class-name">AlertHandler</span> <span class="token punctuation">{</span><span class="token comment">//代码未改动...}</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ErrorAlertHandler</span> <span class="token keyword">extends</span> <span class="token class-name">AlertHandler</span> <span class="token punctuation">{</span><span class="token comment">//代码未改动...}</span>
<span class="token comment">// 改动二：添加新的handler</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TimeoutAlertHandler</span> <span class="token keyword">extends</span> <span class="token class-name">AlertHandler</span> <span class="token punctuation">{</span><span class="token comment">//省略代码...}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ApplicationContext</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token class-name">AlertRule</span> alertRule<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">Notification</span> notification<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">Alert</span> alert<span class="token punctuation">;</span>
  
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initializeBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    alertRule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AlertRule</span><span class="token punctuation">(</span><span class="token comment">/*.省略参数.*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//省略一些初始化代码</span>
    notification <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Notification</span><span class="token punctuation">(</span><span class="token comment">/*.省略参数.*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//省略一些初始化代码</span>
    alert <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Alert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    alert<span class="token punctuation">.</span><span class="token function">addAlertHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TpsAlertHandler</span><span class="token punctuation">(</span>alertRule<span class="token punctuation">,</span> notification<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    alert<span class="token punctuation">.</span><span class="token function">addAlertHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ErrorAlertHandler</span><span class="token punctuation">(</span>alertRule<span class="token punctuation">,</span> notification<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 改动三：注册handler</span>
    alert<span class="token punctuation">.</span><span class="token function">addAlertHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TimeoutAlertHandler</span><span class="token punctuation">(</span>alertRule<span class="token punctuation">,</span> notification<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//...省略其他未改动代码...</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ApiStatInfo</span> apiStatInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApiStatInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...省略apiStatInfo的set字段代码</span>
    apiStatInfo<span class="token punctuation">.</span><span class="token function">setTimeoutCount</span><span class="token punctuation">(</span><span class="token number">289</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 改动四：设置tiemoutCount值</span>
    <span class="token class-name">ApplicationContext</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAlert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>apiStatInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>重构之后的代码更加灵活和易扩展。如果我们要想添加新的告警逻辑，只需要基于扩展的方式创建新的 handler 类即可，不需要改动原来的 check() 函数的逻辑。而且，我们只需要为新的 handler 类添加单元测试，老的单元测试都不会失败，也不用修改。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>我们要时刻具备扩展意识、抽象意识、封装意识。在写代码的时候，我们要多花点时间思考一下，这段代码未来可能有哪些需求变更，如何设计代码结构，事先留好扩展点，以便在未来需求变更的时候，在不改动代码整体结构、做到最小代码改动的情况下，将新的代码灵活地插入到扩展点上。</p></div> <h3 id="lsp-里式替换原则"><a href="#lsp-里式替换原则" class="header-anchor">#</a> LSP 里式替换原则</h3> <p>定义：子类对象（object of subtype/derived class）能够替换程序（program）中父类对象（object of base/parent class）出现的任何地方，并且保证原来程序的逻辑行为（behavior）不变及正确性不被破坏。</p> <h4 id="几个违反里式替换原则的例子"><a href="#几个违反里式替换原则的例子" class="header-anchor">#</a> 几个违反里式替换原则的例子</h4> <ul><li><p><strong>子类违背父类要实现的功能</strong></p> <p>父类中提供的 sortOrdersByAmount() 订单排序函数，是按照金额从小到大来给订单排序的，而子类重写这个 sortOrdersByAmount() 订单排序函数之后，是按照创建日期来给订单排序的。那子类的设计就违背里式替换原则。</p></li> <li><p><strong>子类违背父类对输入、输出、异常的约定</strong></p> <p>在父类中，某个函数约定：运行出错的时候返回 null；获取数据为空的时候返回空集合（empty collection）。而子类重载函数之后，实现变了，运行出错返回异常（exception），获取不到数据返回 null。那子类的设计就违背里式替换原则。在父类中，某个函数约定，输入数据可以是任意整数，但子类实现的时候，只允许输入数据是正整数，负数就抛出，也就是说，子类对输入的数据的校验比父类更加严格，那子类的设计就违背了里式替换原则。在父类中，某个函数约定，只会抛出 ArgumentNullException 异常，那子类的设计实现中只允许抛出 ArgumentNullException 异常，任何其他异常的抛出，都会导致子类违背里式替换原则。</p></li></ul> <h3 id="icp-接口隔离原则"><a href="#icp-接口隔离原则" class="header-anchor">#</a> ICP 接口隔离原则</h3> <p>理解<strong>接口隔离原则</strong>的重点是理解其中的<strong>接口</strong>二字。这里有三种不同的理解。</p> <ul><li><p>如果把“接口”理解为一组接口集合，可以是某个微服务的接口，也可以是某个类库的接口等。如果部分接口只被部分调用者使用，我们就需要将这部分接口隔离出来，单独给这部分调用者使用，而不强迫其他调用者也依赖这部分不会被用到的接口。</p></li> <li><p>如果把“接口”理解为单个 API 接口或函数，部分调用者只需要函数中的部分功能，那我们就需要把函数拆分成粒度更细的多个函数，让调用者只依赖它需要的那个细粒度函数。</p></li> <li><p>如果把“接口”理解为 OOP 中的接口，也可以理解为面向对象编程语言中的接口语法。那接口的设计要尽量单一，不要让接口的实现类和调用者，依赖不需要的接口函数。</p></li></ul> <h3 id="dip-依赖倒置原则"><a href="#dip-依赖倒置原则" class="header-anchor">#</a> DIP 依赖倒置原则</h3> <p>高层模块不要依赖低层模块。高层模块和低层模块应该通过抽象来互相依赖。除此之外，不要依赖具体实现细节，具体实现细节依赖抽象。</p> <p>程序要依赖于抽象接口，不要依赖于具体实现。简单的说就是要求对抽象进行编程，不要对实现进行编程，这样就降低了客户与实现模块间的耦合。</p> <p><strong>理解依赖倒置原则，结合 Spring 的 IOC 和 DI 会更好理解一些。</strong></p> <h4 id="ioc-控制翻转"><a href="#ioc-控制翻转" class="header-anchor">#</a> IOC 控制翻转</h4> <div class="language-java extra-class"><pre class="language-java"><code>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceTest</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">doTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ... </span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//这部分逻辑可以放到框架中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">doTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Test succeed.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Test failed.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在上面的代码中，所有的流程都由程序员来控制。</p> <p>如果我们抽象出一个下面这样一个框架，我们再来看，如何利用框架来实现同样的功能。具体的代码实现如下所示：</p> <div class="language-java extra-class"><pre class="language-java"><code>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">TestCase</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">doTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Test succeed.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Test failed.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">boolean</span> <span class="token function">doTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JunitApplication</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TestCase</span><span class="token punctuation">&gt;</span></span> testCases <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">TestCase</span> testCase<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    testCases<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>testCase<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TestCase</span> <span class="token keyword">case</span><span class="token operator">:</span> testCases<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>把这个简化版本的测试框架引入到工程中之后，我们只需要在框架预留的扩展点，也就是 TestCase 类中的 doTest() 抽象函数中，填充具体的测试代码就可以实现之前的功能了，完全不需要写负责执行流程的 main() 函数了。</p> <p>具体的代码如下所示：</p> <div class="language-java extra-class"><pre class="language-java"><code>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserServiceTest</span> <span class="token keyword">extends</span> <span class="token class-name">TestCase</span> <span class="token punctuation">{</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">doTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ... </span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 注册操作还可以通过配置的方式来实现，不需要程序员显示调用register()</span>
<span class="token class-name">JunitApplication</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UserServiceTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>刚刚举的这个例子，就是典型的通过框架来实现“控制反转”的例子。框架提供了一个可扩展的代码骨架，用来组装对象、管理整个执行流程。程序员利用框架进行开发的时候，只需要往预留的扩展点上，添加跟自己业务相关的代码，就可以利用框架来驱动整个程序流程的执行。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>这里的<strong>控制</strong>指的是对程序执行流程的控制，而<strong>反转</strong>指的是在没有使用框架之前，程序员自己控制整个程序的执行。在使用框架之后，整个程序的执行流程可以通过框架来控制。流程的控制权从程序员<strong>反转</strong>到了框架。</p></div> <h4 id="di-依赖注入"><a href="#di-依赖注入" class="header-anchor">#</a> DI 依赖注入</h4> <p>不通过 new() 的方式在类内部创建依赖类对象，而是将依赖的类对象在外部创建好之后，通过构造函数、函数参数等方式传递（或注入）给类使用。</p> <h4 id="依赖注入框架"><a href="#依赖注入框架" class="header-anchor">#</a> 依赖注入框架</h4> <p>我们通过依赖注入框架提供的扩展点，简单配置一下所有需要的类及其类与类之间依赖关系，就可以实现由框架来自动创建对象、管理对象的生命周期、依赖注入等原本需要程序员来做的事情。</p> <h3 id="kiss-原则"><a href="#kiss-原则" class="header-anchor">#</a> Kiss 原则</h3> <p>尽量保持简单原则。</p> <p><strong>如何写出满足 KISS 原则的代码？</strong></p> <ul><li>不要使用同事可能不懂的技术来实现代码。比如前面例子中的正则表达式，还有一些编程语言中过于高级的语法等。</li> <li>不要重复造轮子，要善于使用已经有的工具类库。经验证明，自己去实现这些类库，出 bug 的概率会更高，维护的成本也比较高。</li> <li>不要过度优化。不要过度使用一些奇技淫巧（比如，位运算代替算术运算、复杂的条件语句代替 if-else、使用一些过于底层的函数等）来优化代码，牺牲代码的可读性。</li></ul> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>实际上，代码是否足够简单是一个挺主观的评判。同样的代码，有的人觉得简单，有的人觉得不够简单。而往往自己编写的代码，自己都会觉得够简单。所以，评判代码是否简单，还有一个很有效的间接方法，那就是 code review。如果在 code review 的时候，同事对你的代码有很多疑问，那就说明你的代码有可能不够“简单”，需要优化啦。</p></div> <h3 id="yang"><a href="#yang" class="header-anchor">#</a> YANG</h3> <p>不要去设计当前用不到的功能；不要去编写当前用不到的代码。实际上，这条原则的核心思想就是：不要做过度设计。</p> <p>我们的系统暂时只用 Redis 存储配置信息，以后可能会用到 ZooKeeper。根据 YAGNI 原则，在未用到 ZooKeeper 之前，我们没必要提前编写这部分代码。当然，这并不是说我们就不需要考虑代码的扩展性。我们还是要预留好扩展点，等到需要的时候，再去实现 ZooKeeper 存储配置信息这部分代码。</p> <h3 id="dry-原则"><a href="#dry-原则" class="header-anchor">#</a> DRY 原则</h3> <p>不要写重复的代码。</p> <p><strong>提高代码复用性的一些方法</strong></p> <ul><li>减少代码耦合</li> <li>满足单一职责原则</li> <li>模块化业务与非业务逻辑分离</li> <li>通用代码下沉</li> <li>继承、多态、抽象、封装</li> <li>应用模板等设计模式</li></ul> <h3 id="lod-迪米特原则"><a href="#lod-迪米特原则" class="header-anchor">#</a> LOD 迪米特原则</h3> <p>也叫最小知识原则。</p> <p>不该有直接依赖关系的类之间，不要有依赖；有依赖关系的类之间，尽量只依赖必要的接口。迪米特法则是希望减少类之间的耦合，让类越独立越好。每个类都应该少了解系统的其他部分。一旦发生变化，需要了解这一变化的类就会比较少。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/designPattern/单例模式.html">单例模式</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3a816497.js" defer></script><script src="/assets/js/2.48b11553.js" defer></script><script src="/assets/js/38.825f4500.js" defer></script>
  </body>
</html>
